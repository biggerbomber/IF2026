---
title: "Plane Crash Analysis: Does your seat matter?"
subtitle: "Inferential Statistics 2025/2026"
author: "Barbato Alberto, Naldoni Martina"
date: "`r Sys.Date()`"
output: 
  pdf_document: 
    toc: true
    fig_height: 6
    number_sections: true
editor_options: 
  markdown: 
    wrap: 80
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Introduction

The Aviation industry is one of the safest in the world. The systems that it has put in place to learn lessons from accidents and make sure they never happen again is well-established and highly regarded. This has made traveling by plane the safest way to travel. 
https://flyfright.com/plane-crash-statistics/#:~:text=Based%20on%20statistics%20from%202015,unharmed%2C%20injured%2C%20or%20killed

But perhaps due to these high safety standards, when an aircraft accident happens it makes headlines all over the world. Anxious passengers fear it's going to happen to them as well and they can't help but ask themselves if there is something they could do to have a safer flight. 

One of the most frequent question that gets asked is : is there a part of the plane that is "safer" than other parts? Can the seating location make a difference in an accident? 

We are going to try to answer this question using statistics.

## Vocabulary

Before starting the analysis, the meaning of some terms must be clarified 

 - Flight : A flight a trip made by an aircraft that connects two airports. It is identified by a number. (Example : AirFrance 225 is the name of the regular service from New Deli to Paris ) 
 
 - Accident : An Accident is an occurrence where a person is fatally or seriously injured, the aircraft sustains significant structural damage, or the aircraft goes missing.
 
 - Incident : An incident is a dangerous situation where no one is seriously hurt and the plane isn't badly damaged.
 
 - Crash : A crash is a type of accident where an aircraft strikes the ground, water, or an obstacle with enough force to cause severe damage or total destruction.
 
 - Accident flight : when a serious accident happens on a flight, usually the companies save the flight number to refer to that flight, and change the flight number for new flights. (Example : Air France 447 was the name of the connection from Rio to Paris, after the 2009 accident the flight became Air France 445)
 
 - Serious injury : Any injury requiring more than 48 hours of hospitalization or involving broken bones (other than fingers/toes)
 
 - Survivability : an accident is defined as survivable if the forces are within human limits and if the structure remained substantially intact 
 
 - CREEP factors : factors that influence the survivability of an accident. They are
    - Container : amount of cabin deformation 
    - Restraints : analysis of the seating structure
    - Environment : presence of lethal contact points
    - Energy Absorption : G-load mitigation by fuselarge or landing gear
    - Post Crash : Other factors (We considered : airport proximity, presence of fire, daytime, phase of flight)


## Literature

While we found no scientific article about this issue, there are many news articles that claim to have conducted "statistical analysis" on aircraft accident data to find which area is the safest in case of a crash. We now list some of their findings : 

 - *Time Article* : "Statistics show that the middle seats in the rear of an aircraft historically have the highest survival rates. [...] The analysis found that the seats in the back third of the aircraft had a 32% fatality rate, compared with 39% in the middle third and 38% in the front third.". This article was written in June 2015.
 
 - https://time.com/3934663/safest-seat-airplane/
 
 - *Reuters Article* :  "Data reveals civil aviation’s most astonishing, exceptional survivals—and shows no seat is reliably safe." 
 
 - https://www.reuters.com/graphics/AVIATION-SAFETY/lgpdaagabvo/
 
 - *Aeroclass Article* : "An analysis of several accidents reveals that:The seats in the back third of the aircraft have a fatality rate of 32%. The seats in the middle third of the plane have a fatality rate of 39%. The seats in the front third have a fatality rate of 38%. [...] The crash data indicates that the front third and middle third of the plane have higher fatality rates than the back third of the plane." This article was written in November 2017.
 
 - https://www.aeroclass.org/the-safest-place-to-sit-on-a-plane/
 
 - *Wired Article* : "While no part of the plane may generally be the safest [...] Each airline emergency plays out differently, affecting different seats more than others each time."
 
 - https://www.wired.com/story/whats-the-safest-seat-on-an-airplane/
 
 - *Allianz Report - Popular Mechanics* : Popular Mechanics also examined 20 accidents and calculated the survival rate in each of four sections of the aircraft. Its results found that in 11 of the 20 crashes, passengers in the rear of the aircraft had a better chance of survival. In seven of those 11 crashes favoring the rear of the aircraft they found the rear section was the only section with survivors. In five accidents the first class and business class
section fared the best with a 49% survivability rate. In three out of the 20 crashes no one location had an advantage.

 - *Allianz Report - University of Greenwich* :  the University of Greenwich studied 105 airline accidents worldwide, and this study concluded that the safest seat on an aircraft is in the one on the aisle nearest the exit, in the front of the aircraft. This seat has a survivability rate of 65% whereas a passenger seated in the rear section only has a 53% survivability rate. Additionally, any seat in the aisle near an exit offers a greater chance of survivability. When seated more than six rows from an exit “the chances of perishing far outweigh those of surviving”
 
 - https://www.allianz.com/content/dam/onemarketing/azcom/Allianz_com/migration/media/press/document/other/AGCS-Global-Aviation-Safety-Study-2014.pdf
 
 
## Perspective 

We are studying if the seating in an airplane has an effect on the survivability of an aircraft accident. To study this, we need to look at all aircraft accidents, then rule out the accidents where every passenger survived, and every accident in which every passenger died. This is an extremely narrow data set of accidents. Of these accidents, we gathered the seatings arrangements and survivor seating maps for 47 crashes. 

If 47 crashes look like a lot, we should consider the greater perspective of air travel safety in general.

https://flyfright.com/plane-crash-statistics/#tve-jump-18c020d9166
reported these figures studying the US General aviation data between 2015 and 2020 : 
 
 - $\frac{1}{260256}$ :  chance of boarding any flight and it being an accident flight
 
 - $\frac{1}{6,864,250}$ : chance of being on a plane involved in an accident that results in at least 1 fatality (possible case study of this study)

 - $\frac{1}{816,545,929}$ chance of you specifically, dying in a plane crash
 
## Data Gathering Process

For this experiment, we found that there weren't already available datasets to get the accident seating maps.

//talk about the fact that in all major accidents either all die or all survive --> wikipedia list 

//not all incidents feature a map. Not all incidents where people both survived and died were crashs (11A)
// argue that we have a significative dataset

We decided that we would gather the information from the final reports that are written as outcomes of all investigations into aircraft accidents. We also gathered data from Wikipedia after checking that the source was indeed the final report of the investigation into the accident. 

//What are FR and that they are official ; redacted by apposite agencies - only official document 

//manually counted all seats, so the data is ours. PILOTS AND FA not included as they are not passengers

We decided that to be able to get some insight on the safest part of the aircraft, we should not use single seats but rather chunks of the aircraft. Not knowing if dividing into thirds or halves, we inserted both these information in our dataset. 
//not all aircraft have the same seating arrangements, little data --> 3 and 2 
 


# Graph dump TO ORGANIZE 


```{r}

data <- read.csv("AllCREEP_cleaned.csv")
# trasform the variables that are categorical into factors
data$fonte <- as.factor(data$fonte)
data$PhaseOfFlight <- as.factor(data$PhaseOfFlight)
data$Time <- as.factor(data$Time)
data$Place <- as.factor(data$Place)
data$HasFire <- as.factor(data$HasFire)
data$Environment <- as.factor(data$Environment)
data$Energy_absorption <- as.factor(data$Energy_absorption)





str(data)
summary(data)
#> data <- read.csv("Aerei_Final.csv")
## 'data.frame': 47 obs. of 26 variables:
## $ Airline : chr "Singapore Airlines" "British Airtours" "British Midland" "China Airlines"
## $ NumVolo : int 6 28 92 120 123 129 140 148 191 204 ...
## $ X1.terzo.lievi : int 17 36 0 0 0 4 0 0 0 3 ...
## $ X1.terzo.gravi : int 2 0 11 0 0 0 0 0 0 0 ...
## $ X1.terzo.morti : int 15 0 22 0 136 14 18 16 55 33 ...
## $ X2.terzo.lievi : int 1 30 4 5 0 5 7 1 0 25 ...
## $ X2.terzo.gravi : int 15 0 30 0 0 0 0 0 8 0 ...
## $ X2.terzo.morti : int 64 16 13 8 214 60 139 34 51 1 ...
## $ X3.terzo.lievi : int 26 10 0 5 36 24 0 8 10 29 ...
## $ X3.terzo.gravi : int 17 0 27 0 0 0 0 0 7 0 ...
## $ X3.terzo.morti : int 0 36 11 21 109 43 91 30 16 0 ...
## $ X1.meta.lievi : int 17 56 32 3 0 7 7 1 0 7 ...
## $ X1.meta.gravi : int 3 0 0 0 0 0 0 0 1 0 ...
## $ X1.meta.morti : int 41 8 34 6 226 23 95 36 79 35 ...
## $ X2.meta.lievi : int 26 20 39 7 4 26 0 7 10 46 ...
## $ X2.meta.gravi : int 31 0 0 0 0 0 0 0 14 0 ...
## $ X2.meta.morti : int 34 44 13 23 225 90 145 46 48 0 ...
## $ fonte : chr "W" "W" "W" "W" ...
## $ PhaseOfFlight : chr "Takeoff" "Takeoff" "Landing" "Landing" ...
## $ Time : chr "Night" "Day" "Night" "Day" ...
2
## $ Place : chr "Airport " "Outside" "Outside" "Airport " ...
## $ HasFire : chr "Fire" "Fire" "Fire" "Fire" ...
## $ Crushed_fuselage : int 1 1 1 1 1 1 1 1 1 1 ...
## $ Restraint_intact : int 0 0 0 1 0 0 0 0 0 0 ...
## $ Environment : chr "dangerous" "dangerous" "dangerous" "clear" ...
## $ Energy_absorption: chr "nogear" "nogear" "gear" "nogear"
                                                                            
                    
```
Some random text....

```{r}
# add a colum of # of seat for each airplain section

data$X1.third.total <- data$X1.terzo.lievi + data$X1.terzo.gravi + data$X1.terzo.morti
data$X2.third.total <- data$X2.terzo.lievi + data$X2.terzo.gravi + data$X2.terzo.morti
data$X3.third.total <- data$X3.terzo.lievi + data$X3.terzo.gravi + data$X3.terzo.morti
data$X1.half.total <- data$X1.meta.lievi + data$X1.meta.gravi + data$X1.meta.morti
data$X2.half.total <- data$X2.meta.lievi + data$X2.meta.gravi + data$X2.meta.morti

str(data)
summary(data)

# now make a colum of mortality rate for each section

data$X1.third.mortality.rate <- data$X1.terzo.morti / data$X1.third.total
data$X2.third.mortality.rate <- data$X2.terzo.morti / data$X2.third.total
data$X3.third.mortality.rate <- data$X3.terzo.morti / data$X3.third.total
data$X1.half.mortality.rate <- data$X1.meta.morti / data$X1.half.total
data$X2.half.mortality.rate <- data$X2.meta.morti / data$X2.half.total



head(data)

```
```{r}
## Plot mortality rates as scatter plots for each section
## they must be separated on the x axis by group

boxplot(data$X1.third.mortality.rate, 
  data$X2.third.mortality.rate, 
  data$X3.third.mortality.rate, 
  data$X1.half.mortality.rate, 
  data$X2.half.mortality.rate, 
  names = c("Front Third", "Middle Third", "Rear Third", "Front Half", "Rear Half"),
  main = "Mortality Rates by Section",
  ylab = "Mortality Rate",
  xlab = "Sections",
  col = c("red", "red", "red", "green", "green"))

```


```{r}
# Perform ANOVA to test if there are significant differences in mortality rates between sections (only  thirds)
mortality_data <- data.frame(
  Section = rep(c("Front Third", "Middle Third", "Rear Third"), each = nrow(data)),
  MortalityRate = c(data$X1.third.mortality.rate, data$X2.third.mortality.rate, data$X3.third.mortality.rate)
)
str(mortality_data)
mortality_data$Section <- as.factor(mortality_data$Section)

anova_result <- aov(MortalityRate ~ Section, data = mortality_data)
summary(anova_result)

library(multcomp)

test_result <- glht(anova_result, linfct = mcp(Section = "Tukey"))
summary(test_result)

#half sections
mortality_data_half <- data.frame(
  Section = rep(c("Front Half", "Rear Half"), each = nrow(data)),
  MortalityRate = c(data$X1.half.mortality.rate, data$X2.half.mortality.rate)
)
anova_result_half <- aov(MortalityRate ~ Section, data = mortality_data_half)
summary(anova_result_half)


#try using non-parametric test if ANOVA assumptions are not met
kruskal_result <- kruskal.test(MortalityRate ~ Section, data = mortality_data)
kruskal_result_half <- kruskal.test(MortalityRate ~ Section, data = mortality_data_half)
kruskal_result
kruskal_result_half

#oneway test

oneway_result <- oneway.test(MortalityRate ~ Section, data = mortality_data, var.equal = FALSE)
oneway_result_half <- oneway.test(MortalityRate ~ Section, data = mortality_data_half, var.equal = FALSE)
oneway_result
oneway_result_half

```

```{r}
# now we do the same thing but considering the "gravi" as casualties too

data$X1.casualties_rate_new <- (data$X1.terzo.morti + data$X1.terzo.gravi) / data$X1.third.total
data$X2.casualties_rate_new <- (data$X2.terzo.morti + data$X2.terzo.gravi) / data$X2.third.total
data$X3.casualties_rate_new <- (data$X3.terzo.morti + data$X3.terzo.gravi) / data$X3.third.total
data$X1.half.casualties_rate_new <- (data$X1.meta.morti + data$X1.meta.gravi) / data$X1.half.total
data$X2.half.casualties_rate_new <- (data$X2.meta.morti + data$X2.meta.gravi) / data$X2.half.total

head(data)


# Plot new casualties rates as scatter plots for each section
boxplot(data$X1.casualties_rate_new, 
  data$X2.casualties_rate_new, 
  data$X3.casualties_rate_new, 
  data$X1.half.casualties_rate_new, 
  data$X2.half.casualties_rate_new, 
  names = c("Front Third", "Middle Third", "Rear Third", "Front Half", "Rear Half"),
  main = "Casualties Rates by Section (Including Serious Injuries)",
  ylab = "Casualties Rate",
  xlab = "Sections",
  col = c("blue", "blue", "blue", "orange", "orange"))  

```


```{r}
# Perform ANOVA to test if there are significant differences in casualties rates between sections (only thirds)
casualties_data <- data.frame(
  Section = rep(c("Front Third", "Middle Third", "Rear Third"), each = nrow(data)),
  CasualtiesRate = c(data$X1.casualties_rate_new, data$X2.casualties_rate_new, data$X3.casualties_rate_new) 
)
anova_casualties_result <- aov(CasualtiesRate ~ Section, data = casualties_data)
summary(anova_casualties_result)

#half sections
casualties_data_half <- data.frame(
  Section = rep(c("Front Half", "Rear Half"), each = nrow(data)),
  CasualtiesRate = c(data$X1.half.casualties_rate_new, data$X2.half.casualties_rate_new) 
)
anova_casualties_result_half <- aov(CasualtiesRate ~ Section, data = casualties_data_half)
summary(anova_casualties_result_half) 

#try using non-parametric test if ANOVA assumptions are not met
kruskal_casualties_result <- kruskal.test(CasualtiesRate ~ Section, data = casualties_data)
kruskal_casualties_result_half <- kruskal.test(CasualtiesRate ~ Section, data = casualties_data_half)
kruskal_casualties_result
kruskal_casualties_result_half

#oneway test
oneway_casualties_result <- oneway.test(CasualtiesRate ~ Section, data = casualties_data, var.equal = FALSE)
oneway_casualties_result_half <- oneway.test(CasualtiesRate ~ Section, data = casualties_data_half, var.equal = FALSE)
oneway_casualties_result
oneway_casualties_result_half


```



```{r}
# t.test only the fisrts third against the rears third
t_test_result <- t.test(data$X1.third.mortality.rate, data$X3.third.mortality.rate, var.equal = FALSE)
t_test_result

#use non-parametric test if t-test assumptions are not met
wilcox_test_result <- wilcox.test(data$X1.third.mortality.rate, data$X3.third.mortality.rate)
wilcox_test_result

```



```{r}
# now we want to test if there is a difference in mortality rate based on the other variables
# PhaseOfFlight, Time, Place, HasFire
# using the total mortality rate, only deaths, do this for evwey third

out <- lm(data$X1.third.mortality.rate ~ data$PhaseOfFlight + data$Time + data$Place + data$HasFire + data$Environment + data$Energy_absorption + data$Crushed_fuselage + data$Restraint_intact)
summary(out)

##simpify the model susins stepwise regression

out_simple <- step(out)
summary(out_simple)

out_2 <- lm(data$X2.third.mortality.rate ~ data$PhaseOfFlight + data$Time + data$Place + data$HasFire + data$Environment + data$Energy_absorption + data$Crushed_fuselage + data$Restraint_intact)
summary(out_2)

out_2_simple <- step(out_2)
summary(out_2_simple)

out_3 <- lm(data$X3.third.mortality.rate ~ data$PhaseOfFlight + data$Time + data$Place + data$HasFire + data$Environment + data$Energy_absorption + data$Crushed_fuselage + data$Restraint_intact)
summary(out_3)

out_3_simple <- step(out_3)
summary(out_3_simple)


#plot the mortality rates based on HasFire
boxplot(data$X1.third.mortality.rate ~ data$HasFire,
        main = "Front Third Mortality Rate by Fire Presence",
        xlab = "Has Fire",
        ylab = "Mortality Rate",
        col = c("yellow", "red"))

boxplot(data$X2.third.mortality.rate ~ data$HasFire,
        main = "Middle Third Mortality Rate by Fire Presence",
        xlab = "Has Fire",
        ylab = "Mortality Rate",
        col = c("yellow", "red")) 

boxplot(data$X3.third.mortality.rate ~ data$HasFire,
        main = "Rear Third Mortality Rate by Fire Presence",
        xlab = "Has Fire",
        ylab = "Mortality Rate",
        col = c("yellow", "red")) 

#and full plane mortality rate
data$Total.mortality.rate <- (data$X1.terzo.morti + data$X2.terzo.morti + data$X3.terzo.morti) / (data$X1.third.total + data$X2.third.total + data$X3.third.total)

boxplot(data$Total.mortality.rate ~ data$HasFire,
        main = "Total Mortality Rate by Fire Presence",
        xlab = "Has Fire",
        ylab = "Mortality Rate",
        col = c("yellow", "red"))

# now for the halves
out_half_1 <- lm(data$X1.half.mortality.rate ~ data$PhaseOfFlight + data$Time + data$Place + data$HasFire + data$Environment + data$Energy_absorption + data$Crushed_fuselage + data$Restraint_intact)
summary(out_half_1)

#simplify the model using stepwise regression
out_half_1_simple <- step(out_half_1 , direction = "both", trace = 0)
summary(out_half_1_simple)


out_half_2 <- lm(data$X2.half.mortality.rate ~ data$PhaseOfFlight + data$Time + data$Place + data$HasFire + data$Environment + data$Energy_absorption + data$Crushed_fuselage + data$Restraint_intact)
summary(out_half_2)

#simplify the model using stepwise regression
out_half_2_simple <- step(out_half_2 , direction = "both", trace = 0)
summary(out_half_2_simple)


#boxplots for halves
boxplot(data$X1.half.mortality.rate ~ data$HasFire,
        main = "Front Half Mortality Rate by Fire Presence",
        xlab = "Has Fire",    
        ylab = "Mortality Rate",
        col = c("lightgreen", "darkgreen"))

boxplot(data$X2.half.mortality.rate ~ data$HasFire,
        main = "Rear Half Mortality Rate by Fire Presence",
        xlab = "Has Fire",
        ylab = "Mortality Rate",
        col = c("lightgreen", "darkgreen")) 



############################################################

#same analysis but using glm with binomial family

out_glm <- glm(cbind(data$X1.terzo.morti, data$X1.third.total - data$X1.terzo.morti) ~ data$PhaseOfFlight + data$Time + data$Place + data$HasFire + data$Environment + data$Energy_absorption + data$Crushed_fuselage + data$Restraint_intact, family = binomial)

summary(out_glm)
out_glm_simple <- step(out_glm, direction = "both", trace = 0)
summary(out_glm_simple)

out_glm_2 <- glm(cbind(data$X2.terzo.morti, data$X2.third.total - data$X2.terzo.morti) ~ data$PhaseOfFlight + data$Time + data$Place + data$HasFire + data$Environment + data$Energy_absorption + data$Crushed_fuselage + data$Restraint_intact, family = binomial)

summary(out_glm_2)
out_glm_2_simple <- step(out_glm_2, direction = "both", trace = 0)
summary(out_glm_2_simple)

out_glm_3 <- glm(cbind(data$X3.terzo.morti, data$X3.third.total - data$X3.terzo.morti) ~ data$PhaseOfFlight + data$Time + data$Place + data$HasFire + data$Environment + data$Energy_absorption + data$Crushed_fuselage + data$Restraint_intact, family = binomial)

summary(out_glm_3)
out_glm_3_simple <- step(out_glm_3, direction = "both", trace = 0)
summary(out_glm_3_simple)

# now for the halves
out_glm_half_1 <- glm(cbind(data$X1.meta.morti, data$X1.half.total - data$X1.meta.morti) ~ data$PhaseOfFlight + data$Time + data$Place + data$HasFire + data$Environment + data$Energy_absorption + data$Crushed_fuselage + data$Restraint_intact, family = binomial)
summary(out_glm_half_1)

out_glm_half_1_simple <- step(out_glm_half_1 , direction = "both", trace = 0)
summary(out_glm_half_1_simple)

out_glm_half_2 <- glm(cbind(data$X2.meta.morti, data$X2.half.total - data$X2.meta.morti) ~ data$PhaseOfFlight + data$Time + data$Place + data$HasFire + data$Environment + data$Energy_absorption + data$Crushed_fuselage + data$Restraint_intact, family = binomial)
summary(out_glm_half_2)
out_glm_half_2_simple <- step(out_glm_half_2 , direction = "both", trace = 0)
summary(out_glm_half_2_simple)



```


```{r}
#same lm analysis but considering casualties (deaths + serious injuries)
out_casualties <- lm(data$X1.casualties_rate_new ~ data$PhaseOfFlight + data$Time + data$Place + data$HasFire + data$Environment + data$Energy_absorption + data$Crushed_fuselage + data$Restraint_intact)
summary(out_casualties)

#simpify the model susins stepwise regression 
out_casualties_simple <- step(out_casualties, direction = "both", trace = 0)
summary(out_casualties_simple)

out_casualties_2 <- lm(data$X2.casualties_rate_new ~ data$PhaseOfFlight + data$Time + data$Place + data$HasFire + data$Environment + data$Energy_absorption + data$Crushed_fuselage + data$Restraint_intact)
summary(out_casualties_2)

out_casualties_2_simple <- step(out_casualties_2, direction = "both", trace = 0)
summary(out_casualties_2_simple)

out_casualties_3 <- lm(data$X3.casualties_rate_new ~ data$PhaseOfFlight + data$Time + data$Place + data$HasFire + data$Environment + data$Energy_absorption + data$Crushed_fuselage + data$Restraint_intact)
summary(out_casualties_3)

out_casualties_3_simple <- step(out_casualties_3, direction = "both", trace = 0)
summary(out_casualties_3_simple)

# now for the halves
out_casualties_half_1 <- lm(data$X1.half.casualties_rate_new ~ data$PhaseOfFlight + data$Time + data$Place + data$HasFire + data$Environment + data$Energy_absorption + data$Crushed_fuselage + data$Restraint_intact)
summary(out_casualties_half_1)

#simplify the model using stepwise regression
out_casualties_half_1_simple <- step(out_casualties_half_1 , direction = "both", trace = 0)
summary(out_casualties_half_1_simple)


out_casualties_half_2 <- lm(data$X2.half.casualties_rate_new ~ data$PhaseOfFlight + data$Time + data$Place + data$HasFire + data$Environment + data$Energy_absorption + data$Crushed_fuselage + data$Restraint_intact)
summary(out_casualties_half_2)
#simplify the model using stepwise regression
out_casualties_half_2_simple <- step(out_casualties_half_2 , direction = "both", trace = 0)
summary(out_casualties_half_2_simple) 




```



```{r}
# now we wnar to study the correlation between the different sections mortality rates
correlation_matrix <- data.frame(
  Front_Third = data$X1.third.mortality.rate,
  Middle_Third = data$X2.third.mortality.rate,
  Rear_Third = data$X3.third.mortality.rate,
  Front_Half = data$X1.half.mortality.rate,
  Rear_Half = data$X2.half.mortality.rate
  
)
correlation_results <- cor(correlation_matrix, use = "complete.obs")
correlation_results

## cor plot
library(corrplot)
corrplot(correlation_results, method = "ellipse", type = "upper", tl.col = "black", tl.srt = 45)

## now study the correlation between the other variables and the total mortality rate
correlation_matrix_2 <- data.frame(
  Total_Mortality_Rate = data$Total.mortality.rate,
  PhaseOfFlight = as.numeric(as.factor(data$PhaseOfFlight)),
  Time = as.numeric(as.factor(data$Time)),
  Place = as.numeric(as.factor(data$Place)),
  HasFire = as.numeric(as.factor(data$HasFire)),
  Environment = as.numeric(as.factor(data$Environment)),
  Energy_absorption = as.numeric(as.factor(data$Energy_absorption)),
  Crushed_fuselage = as.numeric(as.factor(data$Crushed_fuselage)),
  Restraint_intact = as.numeric(as.factor(data$Restraint_intact))
)
correlation_results_2 <- cor(correlation_matrix_2, use = "complete.obs")
correlation_results_2

corrplot(correlation_results_2, method = "ellipse", type = "upper", tl.col = "black", tl.srt = 45)



```

# Data Description

Let's take a look at the structure and meaning of the data we gathered:

```{r load data}
accident_data <- read.csv("AllCREEP_cleaned_eng.csv")
str(accident_data)
#
#> str(accident_data)
#'data.frame':   47 obs. of  26 variables:
# $ Airline          : chr  "singapore airlines" "british airtours" "british midland" "china airlines" ...
# $ FlightNum        : int  6 28 92 120 123 129 140 148 191 204 ...
# $ X1.third.minor   : int  17 36 0 0 0 4 0 0 0 3 ...
# $ X1.third.major   : int  2 0 11 0 0 0 0 0 0 0 ...
# $ X1.third.dead    : int  15 0 22 0 136 14 18 16 55 33 ...
# $ X2.third.minor   : int  1 30 4 5 0 5 7 1 0 25 ...
# $ X2.third.major   : int  15 0 30 0 0 0 0 0 8 0 ...
# $ X2.third.dead    : int  64 16 13 8 214 60 139 34 51 1 ...
# $ X3.third.minor   : int  26 10 0 5 36 24 0 8 10 29 ...
# $ X3.third.major   : int  17 0 27 0 0 0 0 0 7 0 ...
# $ X3.third.dead    : int  0 36 11 21 109 43 91 30 16 0 ...
# $ X1.half.minor    : int  17 56 32 3 0 7 7 1 0 7 ...
# $ X1.half.major    : int  3 0 0 0 0 0 0 0 1 0 ...
# $ X1.half.dead     : int  41 8 34 6 226 23 95 36 79 35 ...
# $ X2.half.minor    : int  26 20 39 7 4 26 0 7 10 46 ...
# $ X2.half.major    : int  31 0 0 0 0 0 0 0 14 0 ...
# $ X2.half.dead     : int  34 44 13 23 225 90 145 46 48 0 ...
# $ DataOrigin       : chr  "w" "w" "w" "w" ...
# $ PhaseOfFlight    : chr  "takeoff" "takeoff" "landing" "landing" ...
# $ Time             : chr  "night" "day" "night" "day" ...
# $ Place            : chr  "airport" "outside" "outside" "airport" ...
# $ HasFire          : chr  "fire" "fire" "fire" "fire" ...
# $ CrushedFuselage : int  1 1 1 1 1 1 1 1 1 1 ...
# $ RestraintIntact : int  0 0 0 1 0 0 0 0 0 0 ...
# $ Environment      : chr  "dangerous" "dangerous" "dangerous" "clear" ...
# $ EnergyAbsorption: chr  "nogear" "nogear" "gear" "nogear" ...
#> 
#
```

## Data Points and Variables 

The data consists of 47 observations (aircraft accidents) and 26 variables. They are the focus of our analysis.

We want to remark that the data consists only of aircraft accidents where there was at least 1 survivor and at least 1 fatality, because the final goal was to compare mortality rates.

// ... 

The variables consist of:

- **Airline & FlightNum** : identifier of the aircraft accident. Useful to retrieve more information about the accident if needed. 

- **X variables** : these variables represent the number and the type of injury (minor-none / serious / fatal) in each section of the airplane (Each third and each half). 
//...
The format is the following : `X{section}.{part}.{type of injury}`, where section is 1,2,3 for the thirds and 1,2 for the halves, part is "third" or "half", and type of injury is "minor", "major" or "dead".

- **DataOrigin** : source of the data, either Wikipedia (W) or directly from the final report (FR) or other sources (empty).
// Remove Column in the data 

- **PhaseOfFlight** : phase of flight when the accident happened, The possible values are "takeoff" or "landing", landing includes emergency landings.

- **Time** : time of the day when the accident happened, possible values are "day" or "night". This is intended to signal if natural light was present or not.

- **Place** : location where the accident happened. Possible values are "airport" or "outside". "Airport" means that the accident happened within airport boundaries (where the airport fire rescue service arrive in less that 3 minutes), "outside" means that the accident happened outside an airport.

- **HasFire**  : indicates if there was an uncontained fire after the crash that spread to the cabin. Possible values are "fire" or "no-fire".

- **CrushedFuselage** : indicates if the fuselage was crushed, so deformed with significant loss of volume,  during the accident. Possible values are 1 (yes) or 0 (no).

- **RestraintIntact** : if the seating structure remained intact and the seat belt system functioned correctly, the Restraint system is considered to have functioned correctly. Possible values are 1 (yes) or 0 (no).

- **Environment** : indicates the state of the cabin after the crash. Possible values are "clear" or "dangerous". It is considered dangerous if it was determined that parts of the cabin like overhead bins failed and debris was scattered in the cabin. 

- **EnergyAbsorption** : indicates if the landing gear was extended and if it absorbed a significant amount of impact forces before collapsing. If not, the airplane either hit the ground wit the gear retracted or hit the ground nose-first or tail-first, causing the impact forces to be absorbed by the passenger cabin. Possible values are "gear" or "nogear"

// fix nogear --> no-gear

## Mortality Rates

To start the analysis, let's prepare the data by adding some useful variables, and transform some variables into a more manageable format.

//...

```{r data preparation}
# add a colum of # of passengers for each airplain section
accident_data <- within(accident_data, {
  X2.half.total  <- X2.half.minor  + X2.half.major  + X2.half.dead
  X1.half.total  <- X1.half.minor  + X1.half.major  + X1.half.dead
  X3.third.total <- X3.third.minor + X3.third.major + X3.third.dead
  X2.third.total <- X2.third.minor + X2.third.major + X2.third.dead
  X1.third.total <- X1.third.minor + X1.third.major + X1.third.dead
})

# now we transform the variables that are categorical into factors
factor_cols <- c("PhaseOfFlight", "Time", "Place", "HasFire", "Environment", 
                 "EnergyAbsorption", "CrushedFuselage", "RestraintIntact")

accident_data[factor_cols] <- lapply(accident_data[factor_cols], as.factor)
```

Now we can add a new variable that will be the center of our analysis : the mortality rate.
It is measured for each section of the airplane. 
The mortality rate is defined as the number of deaths divided by the total number of passengers in the section, for each section. 
Note that aircraft don't always fly on a full load of passengers, so there might be sections with very few passengers or possibly empty. That's why we are considering rates per total passengers instead of per number of seats.

```{r add mortality rates}
accident_data <- within(accident_data, {
  X1.third.mortality.rate <- X1.third.dead / X1.third.total
  X2.third.mortality.rate <- X2.third.dead / X2.third.total
  X3.third.mortality.rate <- X3.third.dead / X3.third.total
  X1.half.mortality.rate  <- X1.half.dead  / X1.half.total
  X2.half.mortality.rate  <- X2.half.dead  / X2.half.total
})
```

What we see in these graphs is very interesting and significant. 

In the first and second thirds we can see that in most cases, either most die or most survive. In the third third the distribution is much more even, except for the relatively high 0% mortality rate frequency. This is already a clue that the diversity is great and therefore 

# Data Analysis

## Preliminary analisys 

### Plotting

The first step we can do is plotting some feature of the data to have a visual understanding of it. 
We do this to get some useful insights and also check for possible outliers or anomalies.

```{r simple boxplots}
with(accident_data, {
  boxplot(X1.third.mortality.rate, 
          X2.third.mortality.rate, 
          X3.third.mortality.rate, 
          X1.half.mortality.rate, 
          X2.half.mortality.rate, 
          names = c("Front Third", "Middle Third", "Rear Third", "Front Half", "Rear Half"),
          main = "Mortality Rates by Section",
          ylab = "Mortality Rate",
          xlab = "Sections",
          col = c("red", "red", "red", "green", "green"),
          cex.axis = 0.9)
})
```

Intestingly, there seems to be a general trend of lowering mortality rates the more rear the section is. 
This is seen in both the third and half divisions of the airplane.

### Distribution 

Now we can try to test the kind of population distribution of the mortality rates, to see if they follow a normal distribution or not. This will help us choose the right statistical tests for our analysis.

We will use the Shapiro-Wilk test for normality.

```{r normality tests}
# shapiro test for normality, p-value extrated and lableled
shapiro_results <- data.frame(
  Section = c("Front Third", "Middle Third", "Rear Third", "Front Half", "Rear Half"),
  P_Value = c(
    shapiro.test(accident_data$X1.third.mortality.rate)$p.value,
    shapiro.test(accident_data$X2.third.mortality.rate)$p.value,
    shapiro.test(accident_data$X3.third.mortality.rate)$p.value,
    shapiro.test(accident_data$X1.half.mortality.rate)$p.value,
    shapiro.test(accident_data$X2.half.mortality.rate)$p.value
  )
)
shapiro_results
```

All of the p-values are far below the standard threshold of 0.05, indicating that we can reject the null hypothesis of normality for all sections. This means that the mortality rates do not follow a normal distribution, let's try to plot a histogram for some of the sections to visualize an approximation of the distribution.

```{r istrogram distribution third, fig.height=8, fig.width=8, echo=FALSE}
par(mfrow = c(3, 2))

colums <- c("X1.third.mortality.rate","X2.third.mortality.rate" ,"X3.third.mortality.rate") 

for( c in colums){
  hist(accident_data[[c]],
       main = paste("Histogram of", gsub("\\.", " ", c)),
       xlab = "Mortality Rate",
       col = "darkgreen",
       border = "black",
       breaks = 100)
}

##histogram for total mortality rate
hist((accident_data$X1.third.dead + accident_data$X2.third.dead + accident_data$X3.third.dead) / 
       (accident_data$X1.third.total + accident_data$X2.third.total + accident_data$X3.third.total),
     main = "Histogram of Total Mortality Rate",
     xlab = "Mortality Rate",
     col = "purple",
     border = "black",
     breaks = 100)

# check for value ==1 or value ==0 of the total mortality rate
accident_data$Total.mortality.rate <- (accident_data$X1.third.dead + accident_data$X2.third.dead + accident_data$X3.third.dead) / 
  (accident_data$X1.third.total + accident_data$X2.third.total + accident_data$X3.third.total)
#sum(accident_data$Total.mortality.rate == 1) # 0
#sum(accident_data$Total.mortality.rate == 0) # 1





colums_half <- c("X1.half.mortality.rate","X2.half.mortality.rate")
for( c in colums_half){
  hist(accident_data[[c]],
       main = paste("Histogram of", gsub("\\.", " ", c)),
       xlab = "Mortality Rate",
       col = "orange",
       border = "black",
       breaks = 100)
}

library(corrplot)

# 1. Setup Data
correlation_matrix <- data.frame(
  Front_Third = accident_data$X1.third.mortality.rate,
  Middle_Third = accident_data$X2.third.mortality.rate,
  Rear_Third = accident_data$X3.third.mortality.rate,
  Total_Mortality_Rate = accident_data$Total.mortality.rate
)

# 2. Create the Color Gradient Logic
# Create a palette generator that goes from Green -> Red
rbPal <- colorRampPalette(c("green", "red"))

# Map the Total_Mortality_Rate variable to 100 bins (shades of color)
# 'cut' divides the numeric range into intervals, returning the index (1-100)
# We use that index to pick the specific color from rbPal
point_colors <- rbPal(2)[as.numeric(cut(correlation_matrix$Total_Mortality_Rate, breaks = 2))]

# 3. Plot
scatterplot_matrix <- function(data) {
  pairs(data, 
        main = "Scatterplot Matrix of Mortality Rates",
        pch = 19, 
        # Pass the vector of colors we created
        col = point_colors,
        lower.panel = NULL) 
}

scatterplot_matrix(correlation_matrix)
```

It seems that there is no clear distribution pattern. 
What we can see is that the data is more concentrated at both ends of the mortality rate values, especially for the front third section.

## Statistical Analysis of differences in mortality rates between sections

Now that we have a better understanding of the data, we can proceed with the statistical analysis to test if there are significant differences in mortality rates between the different sections of the airplane. Also, we will try to see if there is some correlation between the mortality rates and the other variables in the dataset.



Since the distribution of the mortality rates is not normal, we will not use tests that assume normality, like t-tests or ANOVA.
We will instead use the Kruskal-Wallis test, which is a non-parametric test to compare the distribution of two or more groups. The null hypothesis of the Kruskal-Wallis test is that all the populations have the same distribution.

```{r analysis of population differences}
# Kruskal-Wallis test for differences in mortality rates between sections (only thirds)
mortality_data_third <- data.frame(
  SectionThird = rep(c("Front Third", "Middle Third", "Rear Third"), each = nrow(accident_data)),
  MortalityRateThird = c(accident_data$X1.third.mortality.rate, 
                    accident_data$X2.third.mortality.rate, 
                    accident_data$X3.third.mortality.rate)
)

kruskal_result_third <- kruskal.test(MortalityRateThird ~ SectionThird, data = mortality_data_third)
kruskal_result_third

# Kruskal-Wallis test for differences in mortality rates between sections (only halves)
mortality_data_half <- data.frame(
  SectionHalf = rep(c("Front Half", "Rear Half"), each = nrow(accident_data)),
  MortalityRateHalf = c(accident_data$X1.half.mortality.rate, 
                    accident_data$X2.half.mortality.rate)
)

kruskal_result_half <- kruskal.test(MortalityRateHalf ~ SectionHalf, data = mortality_data_half)
kruskal_result_half
```

[Interpretation of results to be added here, OR later in the report]

## Modeling the mortality rates

Now we will try to fit a model to possibly discover the effect of the other variables on the mortality rates of the different sections. The focus is not specifically on prediction, but rather on trying to find a significant difference between the sections. Now the questions are:

- Are there variables that significantly affect the mortality rate?

- If so, do they affect differently the various sections of the airplane?

We will try to fit a Generalized Linear Model (GLM) with binomial family, since the mortality rate is a proportion (number of deaths / total number of passengers). 
Unfortunately, because of the nature of the data, the assumptions of the binomial distribution are not met, since the passenger's deaths are not independent events. 

To account for this, we will use the quasibinomial family, which is a more flexible version of the binomial family that allows for overdispersion and corrects the standard errors and p-values accordingly.  

```{r test glm}
### test glm with binomial family to see the effect of other variables on mortality rate for each section

## also print the varius confidence intervals for the coefficients, and trasform them into odds ratios
glm_third_1 <- glm(cbind(accident_data$X1.third.dead, accident_data$X1.third.total - accident_data$X1.third.dead) ~ 
                     #accident_data$PhaseOfFlight + 
                     #accident_data$Time + 
                     #accident_data$Place + 
                     accident_data$HasFire + 
                     #accident_data$Environment + 
                     accident_data$EnergyAbsorption + 
                     accident_data$CrushedFuselage + 
                     accident_data$RestraintIntact, 
                   family = quasibinomial(link = "logit"))

glm_third_2 <- glm(cbind(accident_data$X2.third.dead, accident_data$X2.third.total - accident_data$X2.third.dead) ~ 
                     #accident_data$PhaseOfFlight + 
                     #accident_data$Time + 
                     #accident_data$Place + 
                     accident_data$HasFire + 
                     #accident_data$Environment + 
                     accident_data$EnergyAbsorption + 
                     accident_data$CrushedFuselage + 
                     accident_data$RestraintIntact, 
                   family = quasibinomial(link = "logit"))

glm_third_3 <- glm(cbind(accident_data$X3.third.dead, accident_data$X3.third.total - accident_data$X3.third.dead) ~ 
                     #accident_data$PhaseOfFlight + 
                     #accident_data$Time + 
                     #accident_data$Place + 
                     accident_data$HasFire + 
                     #accident_data$Environment + 
                     accident_data$EnergyAbsorption + 
                     accident_data$CrushedFuselage + 
                     accident_data$RestraintIntact, 
                   family = quasibinomial(link = "logit"))

# now try to model the total mortality rate

glm_total <- glm(cbind(accident_data$X1.third.dead + accident_data$X2.third.dead + accident_data$X3.third.dead, 
                       accident_data$X1.third.total + accident_data$X2.third.total + accident_data$X3.third.total - 
                         (accident_data$X1.third.dead + accident_data$X2.third.dead + accident_data$X3.third.dead)) ~ 
                   #accident_data$PhaseOfFlight + 
                   #accident_data$Time + 
                   #accident_data$Place + 
                   accident_data$HasFire + 
                   #accident_data$Environment + 
                   accident_data$EnergyAbsorption + 
                   accident_data$CrushedFuselage + 
                   accident_data$RestraintIntact, 
                 family = quasibinomial(link = "logit"))

```



```{r glm summaries}
summary(glm_third_1)
summary(glm_third_2)
summary(glm_third_3)
summary(glm_total)
```


```{r}
x <- rnorm(1000)
hist(x)
```

# Analysis

# Results 

# Conclusions
